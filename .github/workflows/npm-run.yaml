name: NPM RUN

on:
  workflow_call:
    inputs:
      NODE_VERSION:
        type: string
        required: false
        default: "20"
      WORKING_DIRECTORY:
        type: string
        required: false
        default: "app"
      COMMANDS:
        type: string
        required: true
        default: '["test", "lint", "prettier:check"]'
      START_APPLICATION:
        type: boolean
        required: false
        default: false
      START_COMMAND:
        type: string
        required: false
        default: "start:prod"
      APPLICATION_PORT:
        type: string
        required: false
        default: "3000"
      BUILD_BEFORE_START:
        type: boolean
        required: false
        default: false
      BUILD_COMMAND:
        type: string
        required: false
        default: "build"

jobs:
  npm-run:
    runs-on: ubuntu-22.04
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      elasticsearch:
        image: elasticsearch:8.15.0
        ports:
          - 9222:9200
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
    strategy:
      fail-fast: true
      max-parallel: 5
      matrix:
        COMMANDS: ${{ fromJson(inputs.COMMANDS) }}
    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.WORKING_DIRECTORY }}
    steps:
      - name: checkout
        uses: actions/checkout@v5.0.0

      - name: setup node
        uses: actions/setup-node@v6.0.0
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ inputs.WORKING_DIRECTORY }}/package-lock.json

      - name: npm install
        run: npm ci

      - name: build application
        if: ${{ inputs.BUILD_BEFORE_START }}
        run: npm run ${{ inputs.BUILD_COMMAND }}

      - name: start application
        if: ${{ inputs.START_APPLICATION }}
        run: |
          npm run ${{ inputs.START_COMMAND }} &
          echo "Waiting for application to be ready on port ${{ inputs.APPLICATION_PORT }}..."
          timeout 60 bash -c 'until nc -z localhost ${{ inputs.APPLICATION_PORT }}; do sleep 1; done' || {
            echo "Application failed to start on port ${{ inputs.APPLICATION_PORT }}"
            exit 1
          }
          echo "Application is ready on port ${{ inputs.APPLICATION_PORT }}"

      - name: run commands
        run: |
          npm run ${{ matrix.COMMANDS }}
